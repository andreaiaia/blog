---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import { getLangFromUrl } from '../../../i18n/utils';
import BlogPost from '../../../layouts/BlogPost.astro';
import FormattedDate from '../../../components/FormattedDate/FormattedDate.svelte';
import CFImage from '../../../components/CFImage/CFImage.svelte';
import Tag from '../../../components/Tag/Tag.svelte';
import css from '../../../styles/Post.module.scss';

const lang = getLangFromUrl(Astro.url);

export async function getStaticPaths() {
  const posts = (await getCollection('blog')).filter(
    ({ data }) => data.published && data.lang === lang
  );
  return posts.map((post: CollectionEntry<'blog'>) => ({
    params: { slug: post.id },
    props: post,
  }));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { title, description, date, tags, image } = post.data;
const { Content, remarkPluginFrontmatter } = await render(post);
const readingTime = remarkPluginFrontmatter.minutesRead;
---

<BlogPost {...post.data}>
  <article class={css.container}>
    <section class={css.postHead}>
      <CFImage className={css.postImage} src={image} alt={title} />
      <div class={css.postMetadata}>
        <div class={css.tags}>
          {tags.map((tag: string) => <Tag href='#'>{tag}</Tag>)}
        </div>
        <h1>{title}</h1>
        <p>{description}</p>
        <div class={css.stats}>
          <FormattedDate date={date} />
          <p>â€¢</p>
          <p>{readingTime}</p>
        </div>
      </div>
    </section>
    <section class={css.content}>
      <Content />
    </section>
  </article>
</BlogPost>
